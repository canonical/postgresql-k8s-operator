name: Tests
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependencies
        run: python3 -m pip install tox
      - name: Run linters
        run: tox -e lint
  unit-test:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependencies
        run: python -m pip install tox
      - name: Run tests
        run: tox -e unit
  # This job is needed until the OCI image is published to ROCKS.
  build-oci-image:
    name: Build OCI image for integration tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          repository: 'canonical/postgresql-patroni-container'
          ref: 'v0.1.0'
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Build Image and Export
        uses: docker/build-push-action@v2
        with:
          context: ./
          file: ./Dockerfile
          builder: ${{ steps.buildx.outputs.name }}
          # Do not publish the image.
          push: false
          # Set the tag to retrieve the image in Deploy tests.
          tags: postgresql-patroni
          outputs: type=docker,dest=/tmp/image.tar
      - name: Upload image to be used in integration tests
        uses: actions/upload-artifact@v2
        with:
          name: image
          path: /tmp/image.tar
  integration-test-microk8s:
    name: Integration tests (microk8s)
    needs: build-oci-image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup operator environment
        uses: charmed-kubernetes/actions-operator@main
        with:
          provider: microk8s
          # This is needed until https://bugs.launchpad.net/juju/+bug/1977582 is fixed.
          bootstrap-options: "--agent-version 2.9.29"
      # These two steps (download and load image) are needed until the OCI image is published to ROCKS.
      - name: Download image built in build oci image step
        uses: actions/download-artifact@v2
        with:
          name: image
          path: /tmp
      - name: Load Image into microk8s
        run: |
          /usr/bin/sg microk8s -c "microk8s ctr image import /tmp/image.tar"
      - name: Run integration tests
        run: tox -e integration
