[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] maintenance: installing charm software
  untrusted-postgresql-k8s/1 [executing] blocked: Insufficient permissions, try: `juju trust untrusted-postgresql-k8s --scope=cluster`
  untrusted-postgresql-k8s/2 [executing] maintenance: installing charm software
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for cluster to start
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  untrusted-postgresql-k8s/0 [executing] unknown: 
  untrusted-postgresql-k8s/1 [executing] waiting: awaiting for primary endpoint to be ready
  untrusted-postgresql-k8s/2 [executing] unknown: 
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] unknown: 
  untrusted-postgresql-k8s/1 [idle] active: Primary (degraded)
  untrusted-postgresql-k8s/2 [idle] unknown: 
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] active: 
  untrusted-postgresql-k8s/1 [idle] active: Primary (degraded)
  untrusted-postgresql-k8s/2 [idle] waiting: awaiting for cluster to start
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  untrusted-postgresql-k8s/0 [idle] active: 
  untrusted-postgresql-k8s/1 [idle] active: Primary
  untrusted-postgresql-k8s/2 [idle] active:
[32mINFO    [0m pytest_operator.plugin:plugin.py:951 Model status:

Model    Controller          Cloud/Region        Version  SLA          Timestamp
testing  concierge-microk8s  microk8s/localhost  3.6.14   unsupported  00:13:34Z

App                       Version  Status  Scale  Charm           Channel  Rev  Address         Exposed  Message
untrusted-postgresql-k8s  14.20    active      3  postgresql-k8s             0  10.152.183.190  no       

Unit                         Workload  Agent  Address      Ports  Message
untrusted-postgresql-k8s/0   active    idle   10.1.76.139         
untrusted-postgresql-k8s/1*  active    idle   10.1.76.140         Primary
untrusted-postgresql-k8s/2   active    idle   10.1.76.141         

[32mINFO    [0m pytest_operator.plugin:plugin.py:957 Juju error logs:

unit-untrusted-postgresql-k8s-1: 00:10:53 ERROR unit.untrusted-postgresql-k8s/1.juju-log 
            Access to k8s cluster resources is not authorized. This happens when RBAC is enabled and the deployed application was not trusted by the juju admin.
            To fix this issue, run `juju trust untrusted-postgresql-k8s --scope=cluster` (or remove & re-deploy untrusted-postgresql-k8s with `--trust`)
            
unit-untrusted-postgresql-k8s-1: 00:10:53 ERROR unit.untrusted-postgresql-k8s/1.juju-log 
            Access to k8s cluster resources is not authorized. This happens when RBAC is enabled and the deployed application was not trusted by the juju admin.
            To fix this issue, run `juju trust untrusted-postgresql-k8s --scope=cluster` (or remove & re-deploy untrusted-postgresql-k8s with `--trust`)
            
unit-untrusted-postgresql-k8s-0: 00:10:54 ERROR unit.untrusted-postgresql-k8s/0.juju-log Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/model.py", line 3637, in _run
    result = subprocess.run(args, **kwargs)  # type: ignore
  File "/usr/lib/python3.10/subprocess.py", line 526, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command '('/var/lib/juju/tools/unit-untrusted-postgresql-k8s-0/secret-get', '--label', 'database-peers.untrusted-postgresql-k8s.app', '--format=json')' returned non-zero exit status 1.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/src/charm.py", line 2778, in <module>
    main(PostgresqlOperatorCharm, use_juju_for_storage=True)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/__init__.py", line 356, in __call__
    return _main.main(charm_class=charm_class, use_juju_for_storage=use_juju_for_storage)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/_main.py", line 502, in main
    manager.run()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/_main.py", line 486, in run
    self._emit()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/_main.py", line 421, in _emit
    self._emit_charm_event(self.dispatcher.event_name)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/_main.py", line 465, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 924, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 1030, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 1153, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/src/charm.py", line 993, in _on_postgresql_pebble_ready
    self.unit.set_workload_version(self._patroni.rock_postgresql_version)
  File "/usr/lib/python3.10/functools.py", line 981, in __get__
    val = self.func(instance)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/src/charm.py", line 1653, in _patroni
    self.get_secret(APP_SCOPE, REWIND_PASSWORD_KEY),
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 1153, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/src/charm.py", line 393, in get_secret
    if result := self.peer_relation_data(scope).fetch_my_relation_field(peers.id, key):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1779, in fetch_my_relation_field
    if relation_data := self.fetch_my_relation_data([relation_id], [field], relation_name):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1768, in fetch_my_relation_data
    data[relation.id] = self._fetch_my_specific_relation_data(relation, fields)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 664, in wrapper
    return f(self, *args, **kwargs)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 2852, in _fetch_my_specific_relation_data
    self.component, self.local_secret_fields, relation, fields
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 2474, in local_secret_fields
    self.static_secret_fields if self.static_secret_fields else self.current_secret_fields
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 2498, in current_secret_fields
    if content := self._get_group_secret_contents(relation, group):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 2839, in _get_group_secret_contents
    result = super()._get_group_secret_contents(relation, group, secret_fields)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1499, in _get_group_secret_contents
    if (secret := self._get_relation_secret(relation.id, group)) and (
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 636, in wrapper
    return f(self, *args, **kwargs)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 2826, in _get_relation_secret
    return self.secrets.get(
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 981, in get
    if secret.meta:
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 804, in meta
    self._secret_meta = self._model.get_secret(label=self.label)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/model.py", line 325, in get_secret
    content = self._backend.secret_get(id=id, label=label)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/model.py", line 4023, in secret_get
    result = self._run('secret-get', *args, return_output=True, use_json=True)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-0/charm/venv/lib/python3.10/site-packages/ops/model.py", line 3639, in _run
    raise ModelError(e.stderr) from e
ops.model.ModelError: ERROR permission denied

unit-untrusted-postgresql-k8s-0: 00:10:54 ERROR juju.worker.uniter.operation hook "postgresql-pebble-ready" (via hook dispatching script: dispatch) failed: exit status 1
unit-untrusted-postgresql-k8s-0: 00:10:54 ERROR juju.worker.uniter pebble poll failed for container "postgresql": failed to send pebble-ready event: hook failed
unit-untrusted-postgresql-k8s-1: 00:10:55 ERROR unit.untrusted-postgresql-k8s/1.juju-log failed to create k8s services
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lib/python3.10/site-packages/lightkube/core/generic_client.py", line 262, in raise_for_status
    resp.raise_for_status()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lib/python3.10/site-packages/httpx/_models.py", line 829, in raise_for_status
    raise HTTPStatusError(message, request=request, response=self)
httpx.HTTPStatusError: Client error '403 Forbidden' for url 'https://10.152.183.1/api/v1/namespaces/testing/services/untrusted-postgresql-k8s-primary?force=true&fieldManager=untrusted-postgresql-k8s'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/src/charm.py", line 1399, in _fix_pod
    self._create_services()
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 1153, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/src/charm.py", line 1202, in _create_services
    client.apply(
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lib/python3.10/site-packages/lightkube/core/client.py", line 814, in apply
    return self.patch(
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lib/python3.10/site-packages/lightkube/core/client.py", line 479, in patch
    return self._client.request(
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lib/python3.10/site-packages/lightkube/core/generic_client.py", line 342, in request
    return self.handle_response(method, resp, br)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lib/python3.10/site-packages/lightkube/core/generic_client.py", line 276, in handle_response
    self.raise_for_status(resp)
  File "/var/lib/juju/agents/unit-untrusted-postgresql-k8s-1/charm/venv/lib/python3.10/site-packages/lightkube/core/generic_client.py", line 264, in raise_for_status
    raise transform_exception(e) from e
lightkube.core.exceptions.ApiError: services "untrusted-postgresql-k8s-primary" is forbidden: User "system:serviceaccount:testing:untrusted-postgresql-k8s" cannot create resource "services" in API group "" in the namespace "testing"
unit-untrusted-postgresql-k8s-1: 00:10:56 ERROR unit.untrusted-postgresql-k8s/1.juju-log 
            Access to k8s cluster resources is not authorized. This happens when RBAC is enabled and the deployed application was not trusted by the juju admin.
            To fix this issue, run `juju trust untrusted-postgresql-k8s --scope=cluster` (or remove & re-deploy untrusted-postgresql-k8s with `--trust`)
            
unit-untrusted-postgresql-k8s-0: 00:12:45 ERROR unit.untrusted-postgresql-k8s/0.juju-log database-peers:2: Failed to list PostgreSQL database users: connection to server at "untrusted-postgresql-k8s-0.untrusted-postgresql-k8s-endpoints.testing.svc.cluster.local" (10.1.76.139), port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?

unit-untrusted-postgresql-k8s-2: 00:13:01 ERROR unit.untrusted-postgresql-k8s/2.juju-log database-peers:2: Failed to list PostgreSQL database users: connection to server at "untrusted-postgresql-k8s-2.untrusted-postgresql-k8s-endpoints.testing.svc.cluster.local" (10.1.76.141), port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?


[32mINFO    [0m pytest_operator.plugin:plugin.py:1039 Forgetting model main...